buildscript {
  repositories {
    mavenLocal()
    mavenCentral()
  }

  // Get rid of that [expletive deleted] warning about xml-apis 2.0.2/1.0.b2
  configurations.all {
    resolutionStrategy {
      force 'xml-apis:xml-apis:1.4.01'
    }
  }
}

repositories {
  mavenLocal()
  mavenCentral()
}

defaultTasks 'publish'

ant.importBuild "specifications/build.xml"

task publish(dependsOn: ["publish-xpath-functions-40",
                         "publish-xquery-40",
                         "publish-xslt-40"]) {
  inputs.files fileTree(dir: "${buildDir}/www")
  outputs.file "${buildDir}/www/index.html"

  doLast {
    Date now = new Date()
    PrintStream index = new PrintStream(new File("${buildDir}/www/index.html"));
    index.println("<!DOCTYPE html>")
    index.println("<html xmlns='http://www.w3.org/1999/xhtml'>")
    index.println("<head>")
    index.println("<title>QT4CG index page</title>")
    index.println("<style>html { font-size: 16pt }</style>")
    index.println("</head>")
    index.println("<body>")
    index.println("<h1>Index</h1>")
    index.print("<p>Published ")
    index.print(now.format("dd MMM yyyy"))
    index.print(" at ")
    index.print(now.format("HH:mm:ss Z"))
    index.println(".</p>")

    index.println("<ul>");

    def www = new File("${buildDir}/www")
    def indexes = []
    www.listFiles().each { file ->
      int pos = file.toString().indexOf("/www/");
      String path = file.toString().substring(pos+5)
      if (new File("${file}/Overview.html").exists()) {
        index.println("<li><a href='${path}/Overview.html'>${path}</a></li>")
      } else if (new File("${file}/xpath-40.html").exists()) {
        index.println("<li><a href='${path}/xpath-40.html'>xpath-40</a></li>")
        index.println("<li><a href='${path}/xquery-40.html'>xquery-40</a></li>")
      }
    }

    index.println("</body>")
    index.println("</html>")
    index.close();
  }
}

task "publish-xquery-40"(type: Copy,
                         dependsOn: ["publish-xpath-functions-40", "xquery-40"]) {
  into "build/www/xquery-40"
  from "specifications/xquery-40/html"
}

task "publish-xpath-functions-40"(type: Copy,
                                  dependsOn: ["xpath-functions-40"]) {
  into "build/www/xpath-functions-40"
  from "specifications/xpath-functions-40/html"
}

task "publish-xslt-40"(type: Copy,
                       dependsOn: ["publish-xquery-40", "xslt-40"]) {
  into "build/www/xslt-40"
  from "specifications/xslt-40/html"
}
