<?xml version="1.0" encoding="utf-8"?><!DOCTYPE spec SYSTEM "../../../schema/xsl-query.dtd" [<!ENTITY doc.version "1.0"><!ENTITY doc.version-code "10"><!ENTITY doc.stage "NOTE"><!ENTITY doc.w3c-doctype "wgnote"><!ENTITY doc.w3c-doctype-full "Working Group Note"><!ENTITY date.day "25"><!ENTITY date.DD "25"><!ENTITY date.month "January"><!ENTITY date.monthnum "01"><!ENTITY date.year "2011"><!ENTITY doc.date "&date.year;&date.monthnum;&date.DD;"><!ENTITY w3c.tr "http://www.w3.org/TR"><!ENTITY doc.parent.shortname "xquery-update-&doc.version-code;"><!ENTITY doc.shortname "&doc.parent.shortname;-use-cases"><!ENTITY doc.w3c-designation "&doc.stage;-&doc.shortname;"><!ENTITY doc.publoc "&w3c.tr;/&date.year;/&doc.w3c-designation;-&doc.date;/"><!ENTITY doc.latestloc "&w3c.tr;/&doc.shortname;/"><!ENTITY doc.parent.latestloc "&w3c.tr;/&doc.parent.shortname;/"><!ENTITY language "XQuery Update Facility &doc.version;"><!ENTITY post.CR.nochanges ""><!ENTITY % status-entities SYSTEM "../../../etc/status-entities.dtd">%status-entities;<!ENTITY doc.WD-pubdate "07 November 2006"><!ENTITY doc.LC-pubdate "28 August 2007"><!ENTITY doc.LC-comments-due "31 October 2007"><!ENTITY doc.CR-pubdate "2 June 2009"><!ENTITY doc.CR-comments-due "19 June 2009"><!ENTITY doc.PR-expected "31 August 2009"><!ENTITY doc.PR-pubdate "11 January 2011"><!ENTITY doc.PR-comments-due "TO BE SPECIFIED"><!ENTITY doc.REC-pubdate "22 February 2011"><!ENTITY doc.pubdate "&doc.PR-pubdate;"><!ENTITY doc.comments-due "IRRELEVANT"><!ENTITY status-section-id "status"><!ENTITY spec-devby "&devby.xquery;"><!ENTITY changelog-id "id-revisions-log"><!ENTITY changes-para "&post.CR.nochanges;"><!ENTITY implementation-report-location ""><!ENTITY implementation-report-availability ""><!ENTITY implementation-report "&implementation-report-irrelevant;"><!ENTITY disclosure.one "&disclosure.xquery;"><!ENTITY Bugzilla-key "UPDUC"><!ENTITY patent-policy-paragraph "&ppp-one;"><!ENTITY documents-and-relationships "&not-set-of-documents;"><!ENTITY advancement.statement ""><!ENTITY doc-stability "&doc-stability-NOTE;"><!ENTITY PR-entrance-criteria ""><!ENTITY features-at-risk-para "&no-features-at-risk;"><!ENTITY document-stage "&doc-stage-NOTE;"><!ENTITY customized-paragraph '<p>This document incorporates a numberof use cases that guided the development of<loc href="&doc.parent.latestloc;" xlink:type="simple" xlink:show="replace" xlink:actuate="onRequest">&language;</loc>during its design and development. </p>'><!ENTITY status-section SYSTEM "../../../etc/status-general.xml">]><spec w3c-doctype="&doc.w3c-doctype;">  <header>    <title>&language; Use Cases</title>    <w3c-designation>&doc.w3c-designation;</w3c-designation>    <w3c-doctype>W3C &doc.w3c-doctype-full;</w3c-doctype>    <pubdate>      <day>&date.day;</day>      <month>&date.month;</month>      <year>&date.year;</year>    </pubdate>    <publoc>      <loc href="http://www.w3.org/TR/2011/NOTE-xquery-update-10-use-cases-20110125/">&doc.publoc;</loc>    </publoc>    <latestloc>      <loc href="http://www.w3.org/TR/xquery-update-10-use-cases/">&doc.latestloc;</loc>    </latestloc>    <prevlocs diff="chg">      <loc href="http://www.w3.org/TR/2008/CR-xquery-update-10-use-cases-20080314/"/>    </prevlocs>    <authlist>      <author>        <name>Ioana Manolescu</name>        <affiliation>INRIA</affiliation>        <email href="mailto:ioana.manolescu@inria.fr">ioana.manolescu@inria.fr</email>      </author>      <author>        <name>Jonathan Robie</name>        <affiliation>Red Hat</affiliation>        <email href="mailto:jonathan.robie@redhat.com">jonathan.robie@redhat.com</email>      </author>    </authlist>    &status-section;    <abstract>      <p>This document specifies usage scenarios for the XQuery Update Facility.</p>    </abstract>    <langusage>      <language id="EN">English</language>    </langusage>    <revisiondesc>      <p></p>    </revisiondesc>  </header>  <body>    <div1 id="use-cases-for-xquery-updates">      <head>Use Cases for XQuery Updates</head>      <p>The			use cases listed below were created by the <loc href="http://www.w3.org/XML/Query/">XML Query Working Group</loc>      to illustrate important			applications for an XML update facility. Each			use case is focused on a specific application			area, and contains a Document Type Definition			(DTD) and example input data. Each use case			specifies a set of updates that might be			applied to the input data, and the expected			resulting value of the modified input 			for each update. Since the English			description of each query is concise, the			expected results form an important part of the			definition of each update directive.      These use cases are inspired by 			the <loc href="http://www.w3.org/TR/2011/NOTE-xquery-update-10-requirements-20110125/">W3C			XQuery Update Facility Requirements</loc> document.</p>      <p>These use cases represent a snapshot of an          ongoing work. Some important application areas and important          operations are not yet adequately covered by a use case. The          XML Query Working Group reserves the right to add, delete,          or modify individual queries or whole use cases as the work          progresses. The presence of a query in this set of use cases          does not necessarily indicate that the query will be          expressible in the XQuery Update Facility to be created by          the XML Query Working Group.</p>      <div2 id="rdb">        <head>Use Case "R" - Updating Relational Data</head>        <p>One important use of an XML update language will be to update data stored in        relational databases. This use case describes a set of such possible updates.</p>        <div3 id="rdb-description">          <head>Description</head>          <p>This use case is based on					performing updates on the data					used in Use Case "R" from the            <bibref ref="xquery-use-cases"/>. The					sample data from this Use Case					is copied below for					convenience, and exactly match					the data found in the XQuery					1.0 Use Cases. Instead of					DTDs, we describe this data					with W3C XML Schemas.</p>          <p>The data represents a relational database used by an                        online auction. The auction maintains a USERS table                        containing information on registered users, each                        identified by a unique userid, who can either offer                        items for sale or bid on items. An ITEMS table lists                        items currently or recently for sale, with the userid of                        the user who offered each item. A BIDS table contains                        all bids on record, keyed by the userid of the bidder                        and the item number of the item to which the bid                        applies.</p>          <p>The three tables used by the online auction are below,                        with their column-names indicated in parentheses.</p>          <eg>USERS ( USERID, NAME, RATING )ITEMS ( ITEMNO, DESCRIPTION, OFFERED_BY,         START_DATE, END_DATE, RESERVE_PRICE ) BIDS ( USERID, ITEMNO, BID, BID_DATE )</eg>        </div3>        <div3 id="rdb-dtd">          <head>Document Type Definition (DTD)</head>          <p>This use case is based on three separate input documents                        named users.xml, items.xml, and bids.xml. Each of the                        documents represents one of the tables in the relational                      database described above, using the following DTDs:</p>          <div4 id="schema-for-users.xml">            <head>Schema for users.xml</head>            <eg>                      <![CDATA[                      <?xml version="1.0" encoding="UTF-8"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">  <xs:element name="users">    <xs:complexType>      <xs:sequence>        <xs:element minOccurs="0" maxOccurs="unbounded" ref="user_tuple"/>      </xs:sequence>    </xs:complexType>  </xs:element>  <xs:element name="user_tuple">    <xs:complexType>      <xs:sequence>        <xs:element ref="userid"/>        <xs:element ref="name"/>        <xs:element minOccurs="0" ref="rating"/>      </xs:sequence>    </xs:complexType>  </xs:element>  <xs:element name="userid" type="xs:string"/>  <xs:element name="name" type="xs:string"/>  <xs:element name="rating" type="xs:string"/></xs:schema> ]]></eg>          </div4>          <div4 id="schema-for-items.xml">            <head>Schema for items.xml</head>            <eg>                  <![CDATA[<?xml version="1.0" encoding="UTF-8"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">  <xs:element name="items">    <xs:complexType>      <xs:sequence>        <xs:element minOccurs="0" maxOccurs="unbounded" ref="item_tuple"/>      </xs:sequence>    </xs:complexType>  </xs:element>  <xs:element name="item_tuple">    <xs:complexType>      <xs:sequence>        <xs:element ref="itemno"/>        <xs:element ref="description"/>        <xs:element ref="offered_by"/>        <xs:element minOccurs="0" ref="start_date"/>        <xs:element minOccurs="0" ref="end_date"/>        <xs:element minOccurs="0" ref="reserve_price"/>      </xs:sequence>    </xs:complexType>  </xs:element>  <xs:element name="itemno" type="xs:string"/>  <xs:element name="description" type="xs:string"/>  <xs:element name="offered_by" type="xs:string"/>  <xs:element name="start_date" type="xs:string"/>  <xs:element name="end_date" type="xs:string"/>  <xs:element name="reserve_price" type="xs:string"/></xs:schema>]]></eg>          </div4>          <div4 id="schema-for-bids.xml">            <head>Schema for bids.xml</head>            <eg>                      <![CDATA[<?xml version="1.0" encoding="UTF-8"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">  <xs:element name="bids">    <xs:complexType>      <xs:sequence>        <xs:element minOccurs="0" maxOccurs="unbounded" ref="bid_tuple"/>      </xs:sequence>    </xs:complexType>  </xs:element>  <xs:element name="bid_tuple">    <xs:complexType>      <xs:sequence>        <xs:element ref="userid"/>        <xs:element ref="itemno"/>        <xs:element ref="bid"/>        <xs:element ref="bid_date"/>      </xs:sequence>    </xs:complexType>  </xs:element>  <xs:element name="userid" type="xs:string"/>  <xs:element name="itemno" type="xs:string"/>  <xs:element name="bid" type="xs:string"/>  <xs:element name="bid_date" type="xs:string"/></xs:schema>]]>                      </eg>          </div4>        </div3>        <div3 id="rdb-data">          <head>Input Data</head>          <p>The following data is an excerpt of the initial state for Q1. In this particular use case,                     each update begins with the                    state resulting from the prior update.</p>          <eg role="data"><![CDATA[<items>  <item_tuple>    <itemno>1001</itemno>    <description>Red Bicycle</description>    <offered_by>U01</offered_by>    <start_date>1999-01-05</start_date>    <end_date>1999-01-20</end_date>    <reserve_price>40</reserve_price>  </item_tuple>]]>  <emph>  ... Snip ... </emph><![CDATA[</items><users>  <user_tuple>    <userid>U01</userid>    <name>Tom Jones</name>    <rating>B</rating>  </user_tuple>]]>  <emph>  ... Snip ... </emph><![CDATA[</users><bids>  <bid_tuple>     <userid>U02</userid>     <itemno>1001</itemno>     <bid>35</bid>     <bid_date>1999-01-07</bid_date>     </bid_tuple>   <bid_tuple> ]]>  <emph>  ... Snip ... </emph><![CDATA[</bids>]]>                    </eg>          <p>The entire data set is represented by the following tables:</p>          <table border="1" summary="Data set table">            <caption>USERS</caption>            <thead>              <tr>                <td>USERID</td>                <td>NAME</td>                <td>RATING</td>              </tr>            </thead>            <tbody>              <tr>                <td>U01</td>                <td>Tom Jones</td>                <td>B</td>              </tr>              <tr>                <td>U02</td>                <td>Mary Doe</td>                <td>A</td>              </tr>              <tr>                <td>U03</td>                <td>Dee Linquent</td>                <td>D</td>              </tr>              <tr>                <td>U04</td>                <td>Roger Smith</td>                <td>C</td>              </tr>              <tr>                <td>U05</td>                <td>Jack Sprat</td>                <td>B</td>              </tr>              <tr>                <td>U06</td>                <td>Rip Van Winkle</td>                <td>B</td>              </tr>            </tbody>          </table>          <table border="1" summary="Data set table">            <caption>ITEMS</caption>            <thead>              <tr>                <td>ITEMNO</td>                <td>DESCRIPTION</td>                <td>OFFERED_BY</td>                <td>START_DATE</td>                <td>END_DATE</td>                <td>RESERVE_PRICE</td>              </tr>            </thead>            <tbody>              <tr>                <td>1001</td>                <td>Red Bicycle</td>                <td>U01</td>                <td>1999-01-05</td>                <td>1999-01-20</td>                <td>40</td>              </tr>              <tr>                <td>1002</td>                <td>Motorcycle</td>                <td>U02</td>                <td>1999-02-11</td>                <td>1999-03-15</td>                <td>500</td>              </tr>              <tr>                <td>1003</td>                <td>Old Bicycle</td>                <td>U02</td>                <td>1999-01-10</td>                <td>1999-02-20</td>                <td>25</td>              </tr>              <tr>                <td>1004</td>                <td>Tricycle</td>                <td>U01</td>                <td>1999-02-25</td>                <td>1999-03-08</td>                <td>15</td>              </tr>              <tr>                <td>1005</td>                <td>Tennis Racket</td>                <td>U03</td>                <td>1999-03-19</td>                <td>1999-04-30</td>                <td>20</td>              </tr>              <tr>                <td>1006</td>                <td>Helicopter</td>                <td>U03</td>                <td>1999-05-05</td>                <td>1999-05-25</td>                <td>50000</td>              </tr>              <tr>                <td>1007</td>                <td>Racing Bicycle</td>                <td>U04</td>                <td>1999-01-20</td>                <td>1999-02-20</td>                <td>200</td>              </tr>              <tr>                <td>1008</td>                <td>Broken Bicycle</td>                <td>U01</td>                <td>1999-02-05</td>                <td>1999-03-06</td>                <td>25</td>              </tr>            </tbody>          </table>          <table border="1" summary="Data set table">            <caption>BIDS</caption>            <thead>              <tr>                <td>USERID</td>                <td>ITEMNO</td>                <td>BID</td>                <td>BID_DATE</td>              </tr>            </thead>            <tbody>              <tr>                <td>U02</td>                <td>1001</td>                <td>35</td>                <td>1999-01-07</td>              </tr>              <tr>                <td>U04</td>                <td>1001</td>                <td>40</td>                <td>1999-01-08</td>              </tr>              <tr>                <td>U02</td>                <td>1001</td>                <td>45</td>                <td>1999-01-11</td>              </tr>              <tr>                <td>U04</td>                <td>1001</td>                <td>50</td>                <td>1999-01-13</td>              </tr>              <tr>                <td>U02</td>                <td>1001</td>                <td>55</td>                <td>1999-01-15</td>              </tr>              <tr>                <td>U01</td>                <td>1002</td>                <td>400</td>                <td>1999-02-14</td>              </tr>              <tr>                <td>U02</td>                <td>1002</td>                <td>600</td>                <td>1999-02-16</td>              </tr>              <tr>                <td>U03</td>                <td>1002</td>                <td>800</td>                <td>1999-02-17</td>              </tr>              <tr>                <td>U04</td>                <td>1002</td>                <td>1000</td>                <td>1999-02-25</td>              </tr>              <tr>                <td>U02</td>                <td>1002</td>                <td>1200</td>                <td>1999-03-02</td>              </tr>              <tr>                <td>U04</td>                <td>1003</td>                <td>15</td>                <td>1999-01-22</td>              </tr>              <tr>                <td>U05</td>                <td>1003</td>                <td>20</td>                <td>1999-02-03</td>              </tr>              <tr>                <td>U01</td>                <td>1004</td>                <td>40</td>                <td>1999-03-05</td>              </tr>              <tr>                <td>U03</td>                <td>1007</td>                <td>175</td>                <td>1999-01-25</td>              </tr>              <tr>                <td>U05</td>                <td>1007</td>                <td>200</td>                <td>1999-02-08</td>              </tr>              <tr>                <td>U04</td>                <td>1007</td>                <td>225</td>                <td>1999-02-12</td>              </tr>            </tbody>          </table>          <p>The underlying database system has the following referential integrity constraints:</p>          <ulist>          <item><p>A foreign key on the BIDS table requires that BIDS.USERID contains a value that is found in USERS.USERID</p></item>          <item><p>A foreign key on the BIDS table requires that BIDS.ITEMNO contains a value that is found in ITEMS.ITEMNO</p></item>          </ulist>        </div3>        <div3 id="rdb-updates-results">          <head>Updates and Results</head>          <div4 id="rdb-updates-results-u1">            <head>Q1</head>            <p>Add a new user (with no rating) to the users.xml view.</p>            <p>              <emph>Solution in the XQuery Update Facility:</emph>            </p>            <eg><![CDATA[insert nodes   <user_tuple>    <userid>U07</userid>    <name>Annabel Lee</name>  </user_tuple>into doc("users.xml")/users]]></eg>            <p>              <emph>Expected resulting content of users.xml:</emph>            </p>            <eg role="result"><![CDATA[<users>  <user_tuple>    <userid>U01</userid>    <name>Tom Jones</name>    <rating>B</rating>  </user_tuple>  <user_tuple>    <userid>U02</userid>    <name>Mary Doe</name>    <rating>A</rating>  </user_tuple>]]>  <emph>  ... Snip ... </emph><![CDATA[<user_tuple>   <userid>U06</userid>   <name>Rip Van Winkle</name>   <rating>B</rating>  </user_tuple>  <user_tuple>    <userid>U07</userid>    <name>Annabel Lee</name>  </user_tuple></users>]]>						</eg>          </div4>          <div4 id="rdb-updates-results-u2">            <head>Q2</head>            <p>Enter a bid for user Annabel Lee on February 1st, 1999 for 60 dollars on item 1001.</p>            <p>              <emph>Solution in the XQuery Update Facility:</emph>            </p>            <eg><![CDATA[let $uid := doc("users.xml")/users/user_tuple[name="Annabel Lee"]/useridreturn   insert nodes    <bid_tuple>       <userid>{data($uid)}</userid>       <itemno>1001</itemno>       <bid>60</bid>       <bid_date>1999-02-01</bid_date>     </bid_tuple>  into doc("bids.xml")/bids ]]></eg>            <p>              <emph>Expected resulting content of bids.xml:</emph>            </p>            <eg role="result"><![CDATA[<bids>  <bid_tuple>     <userid>U02</userid>     <itemno>1001</itemno>     <bid>35</bid>     <bid_date>1999-01-07</bid_date>   </bid_tuple>   <bid_tuple>     <userid>U04</userid>     <itemno>1001</itemno>     <bid>40</bid>     <bid_date>1999-01-08</bid_date>   </bid_tuple>]]><emph>  ... Snip ... </emph><![CDATA[  <bid_tuple>     <userid>U01</userid>     <itemno>1002</itemno>     <bid>400</bid>     <bid_date>1999-02-14</bid_date>   </bid_tuple>]]>   <emph>  ... Snip ... </emph>  <![CDATA[  <bid_tuple>     <userid>U04</userid>     <itemno>1007</itemno>     <bid>225</bid>     <bid_date>1999-02-12</bid_date>   </bid_tuple>   <bid_tuple>     <userid>U07</userid>     <itemno>1001</itemno>     <bid>60</bid>     <bid_date>1999-02-01</bid_date>   </bid_tuple> </bids>]]>						</eg>          </div4>          <div4 id="rdb-updates-results-u3">            <head>Q3</head>            <p>Insert a new bid for Annabel Lee on item 1002, adding 10% to the best bid received so far for this item.</p>            <p>              <emph>Solution in the XQuery Update Facility:</emph>            </p>            <eg><![CDATA[let $uid := doc("users.xml")/users/user_tuple[name="Annabel Lee"]/useridlet $topbid := max(doc("bids.xml")/bids/bid_tuple[itemno=1002]/bid)return   insert nodes     <bid_tuple>       <userid>{data($uid)}</userid>       <itemno>1002</itemno>       <bid>{$topbid*1.1}</bid>       <bid_date>1999-02-01</bid_date>     </bid_tuple>  into doc("bids.xml")/bids]]></eg>            <p>              <emph>Expected resulting content of bids.xml:</emph>            </p>            <eg role="result"><![CDATA[<bids>  <bid_tuple>     <userid>U02</userid>     <itemno>1001</itemno>     <bid>35</bid>     <bid_date>1999-01-07</bid_date>   </bid_tuple>]]>   <emph>  ... Snip ... </emph><![CDATA[  <bid_tuple>     <userid>U01</userid>     <itemno>1002</itemno>     <bid>400</bid>     <bid_date>1999-02-14</bid_date>   </bid_tuple>]]>   <emph>  ... Snip ... </emph><![CDATA[   <bid_tuple>     <userid>U04</userid>     <itemno>1007</itemno>     <bid>225</bid>     <bid_date>1999-02-12</bid_date>   </bid_tuple>]]>   <emph>  ... Snip ... </emph><![CDATA[  <bid_tuple>     <userid>U07</userid>     <itemno>1002</itemno>     <bid>1320</bid>     <bid_date>1999-03-05</bid_date>   </bid_tuple> </bids>]]>						</eg>            <p>The best bid for item 1002 had been at 1200, thus Annabel's bid is at 1320.</p>          </div4>          <div4 id="rdb-updates-results-u4">            <head>Q4</head>            <p>Set Annabel Lee's rating to B.</p>            <p>              <emph>Solution in the XQuery Update Facility:</emph>              <eg><![CDATA[let $user := doc("users.xml")/users/user_tuple[name="Annabel Lee"]return   if ($user/rating)    then replace value of node $user/rating with "B"    else insert node <rating>B</rating> into $user]]></eg>            </p>            <p>              <emph>Expected resulting content of users.xml:</emph>            </p>            <eg role="result"><![CDATA[<users>  <user_tuple>    <userid>U01</userid>    <name>Tom Jones</name>    <rating>B</rating>  </user_tuple>  <user_tuple>    <userid>U02</userid>    <name>Mary Doe</name>    <rating>A</rating>  </user_tuple>]]>  <emph>  ... Snip ... </emph><![CDATA[  <user_tuple>   <userid>U06</userid>   <name>Rip Van Winkle</name>   <rating>B</rating>  </user_tuple>  <user_tuple>    <userid>U07</userid>    <name>Annabel Lee</name>    <rating>B</rating>  </user_tuple></users>]]>						</eg>          </div4>          <div4 id="rdb-updates-results-u5">            <head>Q5</head>            <p>Place a bid for Annabel Lee 						on item 1007, adding 10% to the            best bid received so far on that item, but only 						if the bid amount does not exceed a given limit.            The first query illustrates the desired behavior if the limit is exceeded.</p>            <p>              <emph>Solution in the XQuery Update Facility:</emph>            </p>            <eg><![CDATA[let $uid := doc("users.xml")/users/user_tuple[name="Annabel Lee"]/useridlet $topbid := max(doc("bids.xml")/bids/bid_tuple[itemno=1007]/bid)where $topbid*1.1 <= 200return   insert nodes     <bid_tuple>       <userid>{data($uid)}</userid>       <itemno>1007</itemno>       <bid>{$topbid*1.1}</bid>       <bid_date>1999-02-01</bid_date>     </bid_tuple>  into doc("bids.xml")/bids]]></eg>            <p>              <emph>Expected resulting content of bids.xml:</emph>            </p>            <eg role="result"><![CDATA[<bids>  <bid_tuple>     <userid>U02</userid>     <itemno>1001</itemno>     <bid>35</bid>     <bid_date>1999-01-07</bid_date>   </bid_tuple>]]>   <emph>  ... Snip ... </emph><![CDATA[    <bid_tuple>     <userid>U04</userid>     <itemno>1007</itemno>     <bid>225</bid>     <bid_date>1999-02-12</bid_date>   </bid_tuple> </bids>]]></eg>            <p>In the above, adding 10% to the best bid on item 1007 would have required a bid of 237,            which is more than the allowed limit of 200. Thus, the bids.xml document does not change.</p>            <p>Place a bid for Annabel Lee 						on item 1007, adding 10% to the                         best bid received so far on that item, but only 						 if the bid amount does not exceed 500. This illustrates the                         behavior when the resulting value is within the limit.</p>            <p>              <emph>Solution in the XQuery Update Facility:</emph>            </p>            <eg><![CDATA[let $uid := doc("users.xml")/users/user_tuple[name="Annabel Lee"]/useridlet $topbid := max(doc("bids.xml")/bids/bid_tuple[itemno=1007]/bid)where $topbid*1.1 <= 500return   insert nodes     <bid_tuple>       <userid>{data($uid)}</userid>       <itemno>1007</itemno>       <bid>{$topbid*1.1}</bid>       <bid_date>1999-02-01</bid_date>     </bid_tuple>  into doc("bids.xml")/bids]]></eg>            <p>              <emph>Expected resulting content of bids.xml</emph>            </p>            <eg role="result"><![CDATA[<bids>  <bid_tuple>     <userid>U02</userid>     <itemno>1001</itemno>     <bid>35</bid>     <bid_date>1999-01-07</bid_date>   </bid_tuple>]]>   <emph>  ... Snip ... </emph><![CDATA[   <bid_tuple>     <userid>U04</userid>     <itemno>1007</itemno>     <bid>225</bid>     <bid_date>1999-02-12</bid_date>   </bid_tuple>   <bid_tuple>     <userid>U07</userid>     <itemno>1007</itemno>     <bid>237</bid>     <bid_date>1999-04-01</bid_date>   </bid_tuple> </bids>]]></eg>          </div4>          <div4 id="rdb-updates-results-u6">            <head>Q6</head>            <p>Erase user Dee Linquent and the corresponding associated items and bids.</p>            <p>              <emph>Solution in the XQuery Update Facility:</emph>            </p>            <eg><![CDATA[let $user := doc("users.xml")/users/user_tuple[name="Dee Linquent"]let $items := doc("items.xml")/items/item_tuple[offered_by=$user/userid]let $bids := doc("bids.xml")/bids/bid_tuple[userid=$user/userid]return (  delete nodes $user,  delete nodes $items,  delete nodes $bids)]]></eg>            <p>An alternative solution is:</p>            <eg><![CDATA[let $user := doc("users.xml")/users/user_tuple[name="Dee Linquent"]let $items := doc("items.xml")/items/item_tuple[offered_by=$user/userid]let $bids := doc("bids.xml")/bids/bid_tuple[userid=$user/userid]return   delete nodes $user, $items, $bids]]></eg>            <p>The two solutions above highlight the fact that a list of delete operationsis equivalent to deleting the list of nodes obtained by concatenating the operands on which the deletes applied.</p>            <p>              <emph>Expected resulting content of items.xml:</emph>            </p>            <eg role="result"><![CDATA[<items>  <item_tuple>    <itemno>1001</itemno>    <description>Red Bicycle</description>    <offered_by>U01</offered_by>    <start_date>1999-01-05</start_date>    <end_date>1999-01-20</end_date>    <reserve_price>40</reserve_price>  </item_tuple>]]>  <emph>  ... Snip ... </emph><![CDATA[  <item_tuple>    <itemno>1004</itemno>    <description>Tricycle</description>    <offered_by>U01</offered_by>    <start_date>1999-02-25</start_date>    <end_date>1999-03-08</end_date>    <reserve_price>15</reserve_price>  </item_tuple>  <item_tuple>    <itemno>1007</itemno>    <description>Racing bicycle</description>    <offered_by>U04</offered_by>    <start_date>1999-01-20</start_date>    <end_date>1999-02-20</end_date>    <reserve_price>200</reserve_price>  </item_tuple>  <item_tuple>    <itemno>1008</itemno>    <description>Broken bicycle</description>    <offered_by>U01</offered_by>    <start_date>1999-02-05</start_date>    <end_date>1999-03-06</end_date>    <reserve_price>25</reserve_price>  </item_tuple></items>]]></eg>            <p>In the above, items 1005 and 1006, 						offered by user Dee Linquent, have been erased; 						item 1007 now directly follows item 1004.                         Notice that the whole subtrees rooted at the corresponding 						&lt;item_tuple&gt; elements have been erased.</p>            <p>              <emph>Expected resulting content of users.xml:</emph>            </p>            <eg role="result"><![CDATA[<users>  <user_tuple>    <userid>U01</userid>    <name>Tom Jones</name>    <rating>B</rating>  </user_tuple>  <user_tuple>    <userid>U02</userid>    <name>Mary Doe</name>    <rating>A</rating>  </user_tuple>   <user_tuple>    <userid>U04</userid>    <name>Roger Smith</name>    <rating>C</rating>  </user_tuple>]]><emph>  ... Snip ... </emph><![CDATA[  <user_tuple>   <userid>U06</userid>   <name>Rip Van Winkle</name>   <rating>B</rating>  </user_tuple></users>]]></eg>            <p>In the above, user Dee Linquent has been erased.</p>            <p>              <emph>Expected resulting content of bids.xml:</emph>            </p>            <eg role="result"><![CDATA[<bids>  <bid_tuple>     <userid>U02</userid>     <itemno>1001</itemno>     <bid>35</bid>     <bid_date>1999-01-07</bid_date>   </bid_tuple>   <bid_tuple>     <userid>U04</userid>     <itemno>1001</itemno>     <bid>40</bid>     <bid_date>1999-01-08</bid_date>   </bid_tuple>]]> <emph>  ... Snip ... </emph><![CDATA[  <bid_tuple>     <userid>U02</userid>     <itemno>1002</itemno>     <bid>600</bid>     <bid_date>1999-02-16</bid_date>   </bid_tuple>   <bid_tuple>     <userid>U04</userid>     <itemno>1002</itemno>     <bid>1000</bid>     <bid_date>1999-02-25</bid_date>   </bid_tuple>]]> <emph>  ... Snip ... </emph><![CDATA[  <bid_tuple>     <userid>U04</userid>     <itemno>1007</itemno>     <bid>225</bid>     <bid_date>1999-02-12</bid_date>   </bid_tuple> </bids>]]></eg>            <p>No bids had been placed on items 1005 and 1006 						offered by user Dee Linquent. However, Dee Linquent 						had placed a bid on item 1002; this bid has been erased.</p>          </div4>          <div4 id="rdb-updates-results-u7">            <head>Q7</head>            <p>Add the element &lt;comment&gt;This is a bargain !&lt;/comment&gt;                         as the last child of the &lt;item&gt; element describing item 1002.</p>            <p>              <emph>Solution in the XQuery Update Facility</emph>            </p>            <eg><![CDATA[declare revalidation strict;insert nodes  <comment>This is a bargain !</comment>as last into doc("items.xml")/items/item_tuple[itemno=1002] ]]></eg>            <p>              <emph>Expected resulting content of items.xml:</emph> The same as the original contents.</p>            <p>The items.xml document is unchanged and an error is raised. This update can						not be applied without rendering the document invalid with respect to its schema.</p>          </div4>          <div4 id="rdb-updates-results-q8">            <head>Q8</head>            <p>Place a bid for						Annabel Lee on item						1010, which does not						exist in						"items.xml". In this						query, we assume that						a referential						integrity constraint						in the underlying						database system						requires that no bid						can be placed on an item						unless it exists in						the database.</p>            <p>              <emph>Solution in XQuery:</emph>              <eg><![CDATA[let $uid := doc("users.xml")/users/user_tuple[name="Annabel Lee"]/useridreturn   insert nodes    <bid_tuple>       <userid>{data($uid)}</userid>       <itemno>1010</itemno>       <bid>60</bid>       <bid_date>2006-04-23</bid_date>     </bid_tuple>  into doc("bids.xml")/bids ]]></eg>            </p>            <p>              <emph>Expected resulting content of bids.xml:</emph>the same as the original contents.</p>            <p>This update violates the previously-mentioned referential integrity constraint.						Therefore, its execution raises a dynamic error (see              <loc href="http://www.w3.org/TR/xquery/#id-kinds-of-errors">Kinds of Errors</loc> in the XQuery specification).              <!--This query was designed to explore referential integrity constraints.						Unfortunately, with the current mapping, we can not express						these constraints with a W3C XML Schema, since there are three						different XML files, and no schema can span them. How do we						account for such constraints, which may well be implemented in						an underlying system?  Do we treat them as system-defined						behavior ?--></p>          </div4>          <div4 id="rdb-updates-results-u9">            <head>Q9</head>            <p>Add a bid for Annabel Lee on item 1002, at a price 5						dollars below the current highest bid.             A trigger in the underlying database ensures that a bid cannot be made at a            lower price than the highest bid made so far on that item.</p>            <p>              <emph>Solution in XQuery:</emph>              <eg><![CDATA[let $uid := doc("users.xml")/users/user_tuple[name="Annabel Lee"]/useridlet $topbid := max(doc("bids.xml")//bid_tuple[itemno=1002]/bid)return   insert nodes    <bid_tuple>       <userid>{data($uid)}</userid>       <itemno>1002</itemno>       <bid>{$topbid - 5.00}</bid>       <bid_date>2006-04-23</bid_date>     </bid_tuple>  into doc("bids.xml")/bids ]]></eg>            </p>            <p>              <emph>Expected resulting content of bids.xml:</emph> the							same as the original contents.</p>            <p>This update causes the previously mentioned trigger to return an error.            Therefore, its execution will raise a dynamic error (see              <loc href="http://www.w3.org/TR/xquery/#id-kinds-of-errors">Kinds of Errors</loc> in the XQuery specification).              <!-- This raises difficulties similar to those seen in						Q9. However, Q9 might be addressed by using a different mapping						and a schema that spans the data, providing identity						contraints. Q10 expresses constraints that can not be						expressed in W3C XML Schema. How do we account for such						constraints, which may well be implemented in						an underlying system?  Do we treat them as						system-defined behavior?--></p>          </div4>        </div3>      </div2>      <div2 id="use-case-sync-addrbook">        <head>Use Case "Address Book" - synchronizing address book entries</head>        <p>In this scenario, an address book is synchronized among a central archive and				two local copies. This scenario is inspired by the Unison file synchronizer.                During synchronization, Address book entries with the same <emph>name</emph> 				element are considered to be the same entry. The order of entries is irrelevant.				For simplicity, we assume that entries may be modified, but not inserted or deleted.				When the two copies are synchronized, their state is saved into an archival version. 				Synchronization is performed as follows:</p>        <ulist>          <item>            <p>If an entry in one of the two copies is different from the archived one,						but the other copy matches the archive, the modified copy is propagated						to the archive and to the other copy.</p>          </item>          <item>            <p>If both copies differ from the archive, but they do not both modify the 						same element in the entry, or they modify the same element but the modified						elements have the same value, then the changes from each copy are propagated 						to both the archive	and the other copy.</p>          </item>          <item>            <p>If the copies have each modified the same entry, but modified it indifferent ways, a problem is reported in the log, and neither thearchive nor the copies are changed. (For simplicity, we do not attempt to merge updates.)</p>          </item>        </ulist>        <p>The XQuery Update Facility is sufficient for the problem as scoped above.        For more complex scenarios, the XQuery Scripting Extensions will simplify programming				by allowing variable assignment and the ability to view the results of prior updates				within a query.</p>        <div3 id="use-case-sync-addrbook-input-data">          <head>Input Data</head>          <p>This section describes the data prior to synchronization.</p>          <p>            <emph>archive.xml</emph>: The central archive, before synchronization.</p>          <eg role="archive-before"><![CDATA[<archived-agenda>  <last-synch-time>2005-10-05T10:00</last-synch-time>  <entry>    <name>Benjamin</name>    <contact>benjamin@inria.fr</contact>  </entry>  <entry>    <name>Dario</name>    <contact>dario@uni-pisa.it</contact>  </entry>  <entry>    <name>Anthony</name>    <contact>tony@uni-toulon.fr</contact>  </entry></archived-agenda>]]></eg>          <p>            <emph>log.xml</emph>: The central log, before synchronization.</p>          <eg role="log-before"><![CDATA[<log></log>]]></eg>          <p>            <emph>copy1.xml</emph>: The first modified copy of the address book.</p>          <p>In this copy, Benjamin's contact has changed from INRIA to University of 				Versailles, Dario has moved from University of Pisa to University of Paris 				Sud, and Anthony has moved from University of Toulon to the ENA.</p>          <eg role="new-v1"><![CDATA[<agenda-version>  <entry>    <name>Benjamin</name>    <contact>benjamin@uni-versailles.fr</contact>  </entry>  <entry>    <name>Dario</name>    <contact>dario@uni-parissud.fr</contact>  </entry>  <entry>    <name>Anthony</name>    <contact>tony@ena.fr</contact>  </entry></agenda-version>]]></eg>          <p>            <emph>copy2.xml</emph>: The second modified copy of the address book.</p>          <p>In this copy, Benjamin has also moved to University of Versailles, Dario has not moved,and Anthony has moved to the EHESS instead of the ENA:</p>          <eg role="new-v2"><![CDATA[<agenda-version>    <entry>    <name>Benjamin</name>    <contact>benjamin@uni-versailles.fr</contact>  </entry>  <entry>    <name>Dario</name>    <contact>dario@uni-pisa.it</contact>  </entry>  <entry>    <name>Anthony</name>    <contact>tony@ehess.fr</contact>  </entry> </agenda-version>]]></eg>        </div3>        <div3 id="addrbook-q1">          <head>Q1</head>          <p>Synchronize the three logs as described in the description					of this use case.</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg><![CDATA[for $a in doc("archive.xml")/archived-agenda/entry,     $v1 in doc("copy1.xml")/agenda-version/entry,     $v2 in doc("copy2.xml")/agenda-version/entrywhere $a/name = $v1/name  and $v1/name = $v2/namereturn   if ($a/contact = $v1/contact and $v1/contact=$v2/contact)  then ()  else     if ($v1/contact = $v2/contact)    then replace value of node $a/contact with $v1/contact    else       if ($a/contact = $v1/contact)      then (            replace value of node $a/contact with $v2/contact,            replace value of node $v1/contact with $v2/contact      )      else         if ($a/contact = $v2/contact)        then (            replace value of node $a/contact with $v1/contact,            replace value of node $v2/contact with $v1/contact        )        else (          insert node            <fail>               <arch>{ $a }</arch>               <v1>{ $v1 }</v1>               <v2>{ $v2 }</v2>            </fail>          into doc("log.xml")/log        ),replace value of node doc("archive.xml")/*/last-synch-time        with current-dateTime()]]>          </eg>          <p>            <emph>Expected Results:</emph>          </p>          <p>            <emph>Expected results of the agenda synchronization</emph>:             A synchronization of the two versions of the agenda made on            April 23th, 2006, at noon, should have the following impact            on the archive, versions, and log.</p>          <note>            <p>In the following XML results, the comments (shown in italic font) were not created by the update directives, and are not part of the result documents. They have been added to explain where each part of aresult document comes from.</p>          </note>          <p>            <emph>archive.xml</emph>          </p>          <eg role="archive-after"><![CDATA[<archived-agenda>  <last-synch-time>2006-04-23T12:00</last-synch-time>  <entry>    <name>Benjamin</name>    ]]>            <emph> copied from the modified entries </emph><![CDATA[    <contact>benjamin@uni-versailles.fr</contact>  </entry>  <entry>    <name>Dario</name>    ]]><emph> copied from first modified version </emph><![CDATA[    <contact>dario@uni-parissud.fr</contact>  </entry>  <entry>    <name>Anthony</name>    ]]><emph>unchanged due to conflict </emph><![CDATA[    <contact>tony@uni-toulon.fr</contact>  </entry></archived-agenda>]]></eg>          <p>            <emph>log.xml</emph>          </p>          <eg role="log-after"><![CDATA[<log>]]>  <emph> update failure details </emph><![CDATA[  <fail>     <arch>       ]]><emph> archived agenda version </emph><![CDATA[       <entry>         <name>Anthony</name>         <contact>tony@uni-toulon.fr</contact>       </entry>     </arch>     <v1>       ]]><emph> first modified version </emph><![CDATA[       <entry>         <name>Anthony</name>         <contact>tony@ena.fr</contact>       </entry>     </v1>     <v2>       ]]><emph> second modified version </emph><![CDATA[       <entry>         <name>Anthony</name>         <contact>tony@ehess.fr</contact>       </entry>     </v2>  </fail></log>]]></eg>          <p>            <emph>copy1.xml</emph>          </p>          <eg role="reconciled-v1"><![CDATA[<agenda-version>  <entry>    <name>Benjamin</name>    ]]>            <emph> kept after synchronization </emph> <![CDATA[   <contact>benjamin@uni-versailles.fr</contact>  </entry>  <entry>    ]]><emph> kept after synchronization </emph><![CDATA[    <name>Dario</name>    <contact>dario@uni-parissud.fr</contact>  </entry>  <entry>    ]]><emph> kept after synchronization failure </emph><![CDATA[    <name>Anthony</name>    <contact>tony@ena.fr</contact>  </entry></agenda-version>]]></eg>          <p>            <emph>copy2.xml</emph>          </p>          <eg role="reconciled-v2"><![CDATA[<agenda-version>    <entry>    ]]>            <emph> kept after synchronization </emph><![CDATA[    <name>Benjamin</name>    <contact>benjamin@uni-versailles.fr</contact>  </entry>  <entry>    ]]><emph> value taken from the other modified version </emph><![CDATA[    <name>Dario</name>    <contact>dario@uni-parissud.fr</contact>  </entry>  <entry>    ]]><emph> kept after synchronization failure </emph><![CDATA[    <name>Anthony</name>    <contact>tony@ehess.fr</contact>  </entry></agenda-version>]]></eg>        </div3>      </div2>      <div2 id="use-case-soap">        <head>Use Case "SOAP" - processing messages</head>        <p>This use case processes the message found in Example 1 of the <bibref ref="SOAPPrimer"/>				to produce the message found in Example 2. The original message is not modified, but				the new message is a modified copy of the original.</p>        <div3 id="use-case-soap-input-data">          <head>Input Data</head>          <p>The input data is taken directly from Example 1 of the <bibref ref="SOAPPrimer"/>.</p>          <eg><![CDATA[<?xml version='1.0' ?><env:Envelope xmlns:env="http://www.w3.org/2003/05/soap-envelope">  <env:Header>  <m:reservation      xmlns:m="http://travelcompany.example.org/reservation"      env:role="http://www.w3.org/2003/05/soap-envelope/role/next"     env:mustUnderstand="true">   <m:reference>uuid:093a2da1-q345-739r-ba5d-pqff98fe8j7d   </m:reference>   <m:dateAndTime>2001-11-29T13:20:00.000-05:00   </m:dateAndTime>  </m:reservation>  <n:passenger     xmlns:n="http://mycompany.example.com/employees"    env:role="http://www.w3.org/2003/05/soap-envelope/role/next"    env:mustUnderstand="true">   <n:name>Åke Jógvan Øyvind</n:name>  </n:passenger> </env:Header> <env:Body>  <p:itinerary    xmlns:p="http://travelcompany.example.org/reservation/travel">   <p:departure>     <p:departing>New York</p:departing>     <p:arriving>Los Angeles</p:arriving>     <p:departureDate>2001-12-14</p:departureDate>     <p:departureTime>late afternoon</p:departureTime>     <p:seatPreference>aisle</p:seatPreference>   </p:departure>   <p:return>     <p:departing>Los Angeles</p:departing>     <p:arriving>New York</p:arriving>     <p:departureDate>2001-12-20</p:departureDate>     <p:departureTime>mid-morning</p:departureTime>     <p:seatPreference/>   </p:return>  </p:itinerary>  <q:lodging   xmlns:q="http://travelcompany.example.org/reservation/hotels">   <q:preference>none</q:preference>  </q:lodging> </env:Body></env:Envelope>]]></eg>          <p>Moreover, we assume the dynamic context associates to "airports" the following sequence:</p>          <eg><![CDATA[<AIRPORT><CITY>New York</CITY><CODE>JFK</CODE></AIRPORT><AIRPORT><CITY>New York</CITY><CODE>LGA</CODE></AIRPORT><AIRPORT><CITY>New York</CITY><CODE>EWR</CODE></AIRPORT><AIRPORT><CITY>Los Angeles</CITY><CODE>LAX</CODE></AIRPORT><AIRPORT><CITY>San Francisco</CITY><CODE>SFO</CODE></AIRPORT>]]></eg>        </div3>        <div3 id="soap-q1">          <head>Q1</head>          <p>Check to see if the airports are unambiguously					specified in the incoming message. Produce a SOAP					response by transforming the incoming message, modifying					the time and date to the current time, and replacing the body          with a request to clarify which airport should be used for New York City.</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg><![CDATA[declare namespace   env="http://www.w3.org/2003/05/soap-envelope";declare namespace   m="http://travelcompany.example.org/reservation";declare namespace   n="http://mycompany.example.com/employees";declare namespace   p="http://travelcompany.example.org/reservation/travel";(:  A clarification is needed only if there are no :  airports or more than one for a given city. If :  there is precisely one, there is no need to :  ask for information on that city. :)declare function local:airportChoices($city as xs:string){  let $airports := collection("airports")[CITY = $city]  return    if (count($airports) = 0)    then        <error> No airports found for {$city}!</error>    else if (count($airports) > 1)     then        <airportChoices>        {           for $c in $airports/CODE          return (string( $c ), " ")        }       </airportChoices>    else ()};(:  Make sure that each airport is unambiguous. If there is :  more than one airport for a city, ask for clarification. : :  The primer only shows the error condition, so it is not :  clear what to do if there are no errors. Here, we simply :  return the airports in the itinerary. :)declare function local:airports($in as element(env:Envelope)){    let $departureDeparting :=       $in//p:departure/p:departing    let $departureDepartingAirports :=       collection("airports")[CITY = $departureDeparting]    let $departureArriving :=       $in//p:departure/p:arriving    let $departureArrivingAirports :=       collection("airports")[CITY = $departureArriving]    let $returnDeparting :=       $in//p:return/p:departing    let $returnDepartingAirports :=       collection("airports")[CITY = $returnDeparting]    let $returnArriving :=       $in//p:return/p:arriving    let $returnArrivingAirports :=       collection("airports")[CITY = $returnArriving]    return       if ( count($departureDepartingAirports)=0 or             count($departureDepartingAirports)>1 or             count($departureArrivingAirports)=0 or             count($departureArrivingAirports)>1 or             count($returnDepartingAirports)=0 or             count($returnDepartingAirports)>1 or             count($returnArrivingAirports)=0 or             count($returnArrivingAirports)>1 )         then          <p:itineraryClarification>            <p:departure>              <p:departing>                { local:airportChoices($departureDeparting) }              </p:departing>              <p:arriving>                { local:airportChoices($departureArriving) }              </p:arriving>             </p:departure>            <p:return>              <p:departing>                { local:airportChoices($returnDeparting) }              </p:departing>              <p:arriving>                { local:airportChoices($returnArriving) }              </p:arriving>            </p:return>          </p:itineraryClarification>         else           <p:itinerary>            <p:departure>              <p:departing>{$departureDeparting}</p:departing>              <p:arriving>{$departureArriving}</p:arriving>            </p:departure>            <p:return>              <p:departing>{$returnDeparting}</p:departing>              <p:arriving>{$returnArriving}</p:arriving>            </p:return>          </p:itinerary>};declare variable $msg external;copy $out := $msg/env:Envelopemodify (  replace value of node $out//m:dateAndTime      with fn:current-dateTime(),  replace node $out//env:Body   with <env:Body>        { local:airports($out) }       </env:Body>)return $out]]></eg>          <p>            <emph>Expected Result (from <bibref ref="SOAPPrimer"/>):</emph>          </p>          <eg><![CDATA[<env:Envelope    xmlns:env="http://www.w3.org/2003/05/soap-envelope">  <env:Header>  <m:reservation     xmlns:m="http://travelcompany.example.org/reservation"     env:role="http://www.w3.org/2003/05/soap-envelope/role/next"    env:mustUnderstand="true">   <m:reference>uuid:093a2da1-q345-739r-ba5d-pqff98fe8j7d   </m:reference>   <m:dateAndTime>2001-11-29T13:35:00.000-05:00   </m:dateAndTime>   </m:reservation>  <n:passenger xmlns:n="http://mycompany.example.com/employees"    env:role="http://www.w3.org/2003/05/soap-envelope/role/next"    env:mustUnderstand="true">   <n:name>Åke Jógvan Øyvind</n:name>  </n:passenger> </env:Header> <env:Body>  <p:itineraryClarification     xmlns:p="http://travelcompany.example.org/reservation/travel">   <p:departure>     <p:departing>       <p:airportChoices>          JFK LGA EWR        </p:airportChoices>     </p:departing>   </p:departure>   <p:return>     <p:arriving>       <p:airportChoices>         JFK LGA EWR        </p:airportChoices>     </p:arriving>   </p:return>    </p:itineraryClarification> </env:Body></env:Envelope>]]></eg>        </div3>      </div2>      <div2 id="use-case-namespaces">        <head>Use Case "Namespaces" - moving elements from one namespace to another</head>        <p>This use case shows how (parts of)				the elements in a document may be				moved from one namespace to another.</p>        <div3 id="use-case-ns-desc">          <head>Description</head>          <p>An agriculture company and an				university research lab are making a				joint proposal to the National				Agricultural Research Agency. An				initial proposal has been made by cut				and paste out of snippets provided by				the two partners. Before being				submitted, the proposal has to be				moved to the National Agricultural				Research Agency (NARA) namespace.</p>        </div3>        <div3 id="use-case-ns-schema-grant-app">          <head>Schema for the grant application</head>          <p>The grant application document must				conform to the following schema:</p>          <eg><![CDATA[<xsd:schema xmlns:xsd='http://www.w3.org/2001/XMLSchema'            targetNamespace="http://www.anr.fr/nara" 	   elementFormDefault="qualified"> <xsd:element name='grant'>  <xsd:complexType>   <xsd:sequence>    <xsd:element ref='name'/>    <xsd:element ref='lab' minOccurs='0' maxOccurs='unbounded'/>   </xsd:sequence>  </xsd:complexType> </xsd:element> <xsd:element name='lab'>  <xsd:complexType>   <xsd:sequence>    <xsd:element ref='address' minOccurs='0' maxOccurs='1'/>    <xsd:choice minOccurs='0' maxOccurs='unbounded'>     <xsd:element ref='researcher'/>     <xsd:element ref='PhD'/>     <xsd:element ref='engineer'/>     <xsd:element ref='lab' minOccurs="0" maxOccurs="unbounded"/>    </xsd:choice>   </xsd:sequence>   <xsd:attribute name='name' type='xsd:string' use='required'/>  </xsd:complexType> </xsd:element> <xsd:element name='PhD'>  <xsd:complexType>   <xsd:attribute name='advisor' type='xsd:IDREF' use='required'/>  </xsd:complexType> </xsd:element> <xsd:element name='researcher'>  <xsd:complexType>   <xsd:attribute name='rid' type='xsd:ID' use='required'/>   <xsd:attribute name='name' type='xsd:string' use='required'/>   <xsd:attribute name='position' type='xsd:string' use='required'/>  </xsd:complexType> </xsd:element> <xsd:element name='engineer'>  <xsd:complexType>   <xsd:attribute name='name' type='xsd:string' use='required'/>  </xsd:complexType> </xsd:element></xsd:schema>]]>          </eg>        </div3>        <div3 id="ns-input-data">          <head>Input Data</head>          <p>The initial draft produced by the participants,					"grant.xml", has the following content. The use of namespaces					reflects the cut-and-paste approach used to create it:</p>          <eg><![CDATA[<?xml version='1.0' ?><grant xmlns:nara="http://www.anr.fr/nara">   <nara:lab name="AgroPlus">      <nara:address>Saclay, France</nara:address>      <nara:researcher rid="r1" name="Fred"        position="technical staff"/>      <nara:researcher rid="r2" name="Liz"        position="lab assistant" />      <coop:PhD        xmlns:coop="http://www.gouv.fr/univ-industry-coop/"        name="Marie" advisor="r1"/>      <agro:lab xmlns:agro="http://www.agroplus.com"        name="Dairy Dept">        <agro:engineer name="Marc"/>      </agro:lab>   </nara:lab>   <univ:lab xmlns:univ="http://www.education.gouv.fr"     name="Food Engineering Dept, Orsay U.">     <univ:address>Orsay, France</univ:address>     <univ:researcher rid="r3" name="Henry"       position="associate professor"/>     <univ:PhD name="Robert" advisor="r3"/>     <PhD name="Julia" advisor="r1"/>   </univ:lab> </grant> 	]]></eg>        </div3>        <div3 id="ns-q1">          <head>Q1</head>          <p>Move all elements into the NARA namespace					("http://www.anr.fr/nara").</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg>					<![CDATA[declare namespace nara = "http://www.anr.fr/nara";for $e in doc("grant.xml")//*where not (namespace-uri($e) eq "http://www.anr.fr/nara")return   rename node $e       as QName("http://www.anr.fr/nara",                concat("nara:",local-name($e)))]]></eg>          <p>            <emph>Expected Result:</emph>          </p>          <eg><![CDATA[<nara:grant xmlns:nara="http://www.anr.fr/nara"> <nara:lab name="AgroPlus">   <nara:address>Saclay, France</nara:address>   <nara:researcher rid="r1" name="Fred"      position="technical staff"/>   <nara:researcher rid="r2" name="Liz"      position="lab assistant" />   <nara:PhD      xmlns:coop="http://www.gouv.fr/univ-industry-coop/"     name="Marie" advisor="r1"/>    <nara:lab name="Dairy Dept">      <nara:engineer name="Marc"/>   </nara:lab> </nara:lab> <nara:lab name="Food Engineering Dept, Orsay U.">  <nara:address>Orsay, France</nara:address>  <nara:researcher rid="r3" name="Henry"     position="associate professor"/>  <nara:PhD name="Robert" advisor="r3"/>  <nara:PhD name="Julia" advisor="r1"/> </nara:lab></nara:grant>]]></eg>        </div3>      </div2>      <div2 id="use-case-parts">        <head>Use case "Parts" - modifying recursive documents</head>        <p>This use case illustrates modifications to documents having a recursive structure.</p>        <div3 id="use-case-parts-input">          <head>Input data</head>          <p>Each update in this use case applies on the following documents. In these examples, we assume each update is applied to a fresh copyof the original data.</p>          <p>Document "part-tree.xml":</p>          <eg><![CDATA[<parttree>    <part partid="0" name="car">        <part partid="1" name="engine">            <part partid="3" name="piston"/>        </part>        <part partid="2" name="door">            <part partid="4" name="window"/>            <part partid="5" name="lock"/>        </part>    </part>    <part partid="10" name="skateboard">        <part partid="11" name="board"/>        <part partid="12" name="wheel"/>    </part>    <part partid="20" name="canoe"/></parttree>]]>          </eg>          <p>Document "part-list.xml":</p>          <eg><![CDATA[<?xml version="1.0" encoding="ISO-8859-1"?><partlist>  <part partid="0" name="car"/>  <part partid="1" partof="0" name="engine"/>  <part partid="2" partof="0" name="door"/>  <part partid="3" partof="1" name="piston"/>  <part partid="4" partof="2" name="window"/>  <part partid="5" partof="2" name="lock"/>  <part partid="10" name="skateboard"/>  <part partid="11" partof="10" name="board"/>  <part partid="12" partof="10" name="wheel"/>  <part partid="20" name="canoe"/></partlist>]]>          </eg>        </div3>        <div3 id="use-case-parts-q1">          <head>Q1</head>          <p>Delete all parts in "part-tree.xml".</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg><![CDATA[delete nodes doc("part-tree.xml")//part]]></eg>          <p>            <emph>Expected resulting document "part-tree.xml":</emph>          </p>          <eg><![CDATA[<parttree/>]]></eg>        </div3>        <div3 id="use-case-parts-q2">          <head>Q2</head>          <p>Delete all parts belonging to a car in "part-tree.xml", leavingthe car itself.</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg><![CDATA[delete nodes doc("part-tree.xml")//part[@name="car"]//part]]></eg>          <p>            <emph>Expected resulting document "part-tree.xml":</emph>          </p>          <eg><![CDATA[<parttree>    <part partid="0" name="car"/>    <part partid="10" name="skateboard">        <part partid="11" name="board"/>        <part partid="12" name="wheel"/>    </part>    <part partid="20" name="canoe"/></parttree>]]>          </eg>        </div3>        <div3 id="use-case-parts-q3">          <head>Q3</head>          <p>Delete all parts belonging to a car in "part-list.xml", leavingthe car itself.</p>          <p>            <emph>Solution 1 in the XQuery Update Facility (leveraging "part-tree.xml"):</emph>          </p>          <eg><![CDATA[for $pt in doc("part-tree.xml")//part[@name="car"]//part,     $pl in doc("part-list.xml")//partwhere $pt/@partid eq $pl/@partidreturn   delete nodes $pl]]>          </eg>          <p>            <emph>Solution 2 (using a recursive updating function):</emph>          </p>          <eg><![CDATA[declare updating function     local:delete-subtree($p as element(part))  {      for $child in doc("part-list.xml")//part      where $p/@partid eq $child/@partof      return (        delete nodes $child,        local:delete-subtree($child)      )  };for $p in doc("part-list.xml")//part[@name="car"]return   local:delete-subtree($p)]]>          </eg>          <note>            <p>Because this data is not covered by a schema, an implementation that supports static typing will raise an error for the comparison <code>$p/@partid eq $child/@partof</code>. This can be solved by creating a schema for the data and importing it into the query.</p>          </note>          <p>            <emph>Expected Result:</emph>          </p>          <eg><![CDATA[<partlist>  <part partid="0" name="car"/>  <part partid="10" name="skateboard"/>  <part partid="11" partof="10" name="board"/>  <part partid="12" partof="10" name="wheel"/>  <part partid="20" name="canoe"/></partlist>]]>          </eg>        </div3>        <div3 id="use-case-parts-q4">          <head>Q4</head>          <p>Add a radio to the car in "part-tree.xml", using a part numberthat hasn't been taken.</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg><![CDATA[let $next := max(doc("part-tree.xml")//@partid) + 1  return    insert nodes <part partid="{$next}" name="radio"/>       into        doc("part-tree.xml")//part[@partid=0 and @name="car"]]]>          </eg>          <p>            <emph>Expected Result:</emph>          </p>          <eg><![CDATA[<parttree>    <part partid="0" name="car">        <part partid="21" name="radio"/>        <part partid="1" name="engine">            <part partid="3" name="piston"/>        </part>        <part partid="2" name="door">            <part partid="4" name="window"/>            <part partid="5" name="lock"/>        </part>    </part>    <part partid="10" name="skateboard">        <part partid="11" name="board"/>        <part partid="12" name="wheel"/>    </part>    <part partid="20" name="canoe"/></parttree>]]>          </eg>          <p>            <emph>Note:</emph>The position of the new element with respect to its siblings isimplementation-dependent. If position is significant, and the userwants to ensure the element appears last, for example, "as last" should be used, asin the following query:</p>          <eg><![CDATA[let $next := max(doc("part-tree.xml")//@partid) + 1  return    insert nodes <part partid="{$next}" name="radio"/>       as last       into doc("part-tree.xml")//part[@partid=0 and @name="car"]]]>          </eg>        </div3>        <div3 id="use-case-parts-q6">          <head>Q6</head>          <p>The head office has adopted a new numbering scheme. In"part-tree.xml", add 1000 to all part numbers for cars, 2000 to allpart numbers for skateboards, and 3000 to all part numbers for canoes.</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg><![CDATA[for $keyword at $i in ("car", "skateboard", "canoe"),    $parent in doc("part-tree.xml")//part[@name=$keyword]let $descendants := $parent//partfor $p in ($parent, $descendants)return   replace value of node $p/@partid with $i*1000+$p/@partid]]>          </eg>          <p>            <emph>Expected result:</emph>          </p>          <eg><![CDATA[<parttree>    <part partid="1000" name="car">        <part partid="1021" name="radio"/>        <part partid="1001" name="engine">            <part partid="1003" name="piston"/>        </part>        <part partid="1002" name="door">            <part partid="1004" name="window"/>            <part partid="1005" name="lock"/>        </part>    </part>    <part partid="2010" name="skateboard">        <part partid="2011" name="board"/>        <part partid="2012" name="wheel"/>    </part>    <part partid="3020" name="canoe"/></parttree>]]>          </eg>        </div3>      </div2>      <div2 id="use-case-nil">        <head>Use case "Nil"</head>        <p>This use case demonstrates transform expressions which constructmodified copies of some data, which must remain valid according to theoriginal schema.  In this use case, keeping the modified copy validrequires adding an xsi:nil attribute.</p>        <div3 id="use-case-nil-schema">          <head>XML Schema</head>          <p>A employees data set is described by the following XML Schema:</p>          <eg><![CDATA[<?xml version="1.0" encoding="UTF-8" ?><xsd:schema   targetNamespace="http://www.example.com/employees"  xmlns:xs="http://www.w3.org/2001/XMLSchema">  <xsd:element name="employees">    <xsd:complexType>      <xsd:element name="employee" minOccurs="0"         maxOccurs="unbounded">        <xsd:complexType>          <xsd:attribute name="mgr" type="xsd:boolean"           default="false"/>          <xsd:attribute name="dept" type="xsd:string"/>          <xsd:sequence>            <xsd:element name="name" type="xsd:string"/>            <xsd:element name="salary" type="xsd:decimal"               nillable="true"/>          </xsd:sequence>        </xsd:complexType>      </xsd:element>    </xsd:complexType>  </xsd:element></xsd:schema>]]>          </eg>        </div3>        <div3 id="use-case-nil-input-data">          <head>Sample input data ("employees.xml")</head>          <eg><![CDATA[<employees>  <employee mgr="true" dept="Toys">    <name>Smith</name>    <salary>100000</salary>  </employee>  <employee dept="Toys">    <name>Jones</name>    <salary>60000</salary>  </employee>  <employee mgr="true" dept="Shoes">    <name>Roberts</name>    <salary>150000</salary>  </employee></employees>]]>          </eg>        </div3>        <div3 id="use-case-nil-q1">          <head>Q1</head>          <p>Return all managers, omitting their salaries for confidentialityreasons. The returned document must be valid according to its XMLSchema, so the query adds an xsi:nil attribute with value "true" tothe salary element.</p>          <p>            <emph>Solution in the XQuery Update Facility:</emph>          </p>          <eg><![CDATA[for $e in doc("employees.xml")//employeewhere $e/@manager = true()return   copy $emp := $e   modify (     replace value of node $emp/salary with "" ,     insert nodes (attribute xsi:nil {"true"})         into $emp/salary   )   return $emp]]>          </eg>          <p>            <emph>Expected result:</emph>          </p>          <eg><![CDATA[<employee mgr="true" dept="Toys">  <name>Smith</name>  <salary xsi:nil="true"/></employee><employee mgr="true" dept="Shoes">  <name>Roberts</name>  <salary xsi:nil="true"/></employee>]]>          </eg>        </div3>      </div2>    </div1>  </body>  <back>    <div1 id="references">      <head>Normative References</head>      <blist>        <bibl key="XQuery 1.0" id="xquery"/>        <bibl key="XML Query Use Cases" id="xquery-use-cases"/>        <bibl key="XQuery Update Facility 1.0 Requirements" id="xquery-update-10-requirements"/>        <bibl key="XQuery Update Facility 1.0" id="xquery-update-10"/>        <bibl key="SOAP Version 1.2 Part 0:Primer" id="SOAPPrimer">World WideWeb Consortium. <emph>SOAP Version 1.2 Part 0: Primer</emph>W3C Recommendation 24 June 2003. See <loc href="http://www.w3.org/TR/2003/REC-soap12-part0-20030624/"/>.</bibl>      </blist>    </div1>    <inform-div1 id="id-revisions-log">      <head>Revision Log</head>      <p>This log records the substantive changes that have been made to this document since the Working Draft of 8 May 2006.       Minor editorial changes are not included in this log.</p>      <div2 id="id-log-pending">        <!-- Change to the date of the next publication when known -->        <head>Changes in internal WD</head>        <ulist>          <item>            <p>Clarified that the "application constraint" in 1.1.4.8 Q8 is a database integrity constraint,            and added the constraint to the description of the data, in response to            http://www.w3.org/Bugs/Public/show_bug.cgi?id=3796#add_comment.</p>          </item>        </ulist>      </div2>      <div2 id="id-log-28aug2007">        <head>28 Aug 2007 Publication</head>        <ulist>          <item>            <p>Clarified that updates for Use Case "R" are cumulative (see http://www.w3.org/Bugs/Public/show_bug.cgi?id=3567#c1).</p>          </item>          <item>            <p>Fixed update conflict in Use Case "Address", and clarified that some things would be easier using updates together with the Scripting Extensions (see http://www.w3.org/Bugs/Public/show_bug.cgi?id=3578#c1).</p>          </item>          <item>            <p>Fixed several errors in Use Case "SOAP" (see http://www.w3.org/Bugs/Public/show_bug.cgi?id=3578#c3).</p>          </item>          <item>            <p>Fixed Use Case "R" Q4 so that it tests to see whether a rating already exists (see http://www.w3.org/Bugs/Public/show_bug.cgi?id=3578#c4).</p>          </item>          <item>            <p>Fixed Use Case "Parts" Q3, fixing several bugs, see (http://www.w3.org/Bugs/Public/show_bug.cgi?id=3578#c6).</p>          </item>        </ulist>      </div2>    </inform-div1>  </back></spec>